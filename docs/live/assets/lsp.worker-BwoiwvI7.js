let i=null,o=null;async function m(r,e){if(importScripts(e),typeof self.Go!="function")throw new Error("Go WASM runtime not found after loading wasm_exec.js");const s=new self.Go;let t;const n=new Promise(l=>t=l);self.__langlangReadyResolve=()=>t?.();const a=await fetch(r);if(!a.ok)throw new Error(`Failed to fetch WASM: ${a.statusText}`);const p=await WebAssembly.instantiateStreaming(a,s.importObject),c=s.run(p.instance);if(c.catch(l=>{console.error("[lsp.worker] Go runtime crashed:",l)}),await Promise.race([n,c.then(()=>{throw new Error("Go runtime exited before ready")}),new Promise((l,f)=>setTimeout(()=>f(new Error("Timeout waiting for WASM init")),5e3))]),o=self.langlang??self.langlangWasm??null,!o)throw new Error("langlang WASM bindings not initialized");i=o.lspHandle??null,i||console.warn("[lsp.worker] LSP handle not available in this WASM build")}function g(r,e){if(!i){self.postMessage({type:"lsp-error",id:r,error:"LSP not available"});return}try{const s=i(JSON.stringify(e));if(!s.ok){self.postMessage({type:"lsp-error",id:r,error:s.error});return}const t=JSON.parse(s.value);self.postMessage({type:"lsp-response",id:r,messages:Array.isArray(t)?t:[]})}catch(s){self.postMessage({type:"lsp-error",id:r,error:s instanceof Error?s.message:String(s)})}}function u(r,e,s,t,n){if(!o){self.postMessage({type:"compile-error",id:r,error:"WASM not initialized"});return}try{let a;if(s&&t?a=o.matcherFromFiles(t,s,n):a=o.matcherFromString(e,n),!a.ok){self.postMessage({type:"compile-error",id:r,error:a.error});return}self.postMessage({type:"compile-response",id:r,matcherId:a.value.id})}catch(a){self.postMessage({type:"compile-error",id:r,error:a instanceof Error?a.message:String(a)})}}function h(r,e,s){if(!o){self.postMessage({type:"match-error",id:r,error:"WASM not initialized"});return}try{const t=o.match(e,s);if(!t.ok){self.postMessage({type:"match-error",id:r,error:t.error});return}self.postMessage({type:"match-response",id:r,consumed:t.value.consumed,value:t.value.value})}catch(t){self.postMessage({type:"match-error",id:r,error:t instanceof Error?t.message:String(t)})}}function y(r){if(o)try{o.freeMatcher(r)}catch(e){console.error("[lsp.worker] Failed to free matcher:",e)}}self.onmessage=async r=>{const e=r.data;switch(e.type){case"init":try{await m(e.wasmUrl,e.wasmExecUrl),self.postMessage({type:"ready"})}catch(s){self.postMessage({type:"init-error",error:s instanceof Error?s.message:String(s)})}break;case"lsp":g(e.id,e.message);break;case"compile":u(e.id,e.grammar,e.files,e.entry,e.config);break;case"match":h(e.id,e.matcherId,e.input);break;case"freeMatcher":y(e.matcherId);break}};
