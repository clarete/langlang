#!/bin/bash

VERSION=$(git describe --tags --always --dirty)

declare -a suites=(
    "arithmetic"
    "arithmetic_leftrec"
    "charsets"
    "import"
    "json"
    "langlang"
)

diff_benchmarks() {
    local version1=go/$1
    local version2=go/$2

    if [ ! -d "benches/${version1}" ]; then
        echo "Error: Version ${version1} not found in benches/"
        exit 1
    fi
    if [ ! -d "benches/${version2}" ]; then
        echo "Error: Version ${version2} not found in benches/"
        exit 1
    fi
    for suite in "${suites[@]}"; do
        local variants=("${suite}" "${suite}_nocap")

        if [ "${suite}" = "json" ]; then
            variants+=("${suite}_stripped" "${suite}_stripped_nocap")
        fi
        for variant in "${variants[@]}"; do
            local path1="benches/${version1}/${variant}"
            local path2="benches/${version2}/${variant}"

            if [ ! -d "$path1" ] || [ ! -d "$path2" ]; then
                continue
            fi

            echo "# ----------------------- ${variant} ----------------------"

            benchstat "${path1}/txt" "${path2}/txt"
        done
    done
}

# Parse command line arguments
if [ "$1" = "--diff" ] || [ "$1" = "-d" ]; then
    if [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: $0 --diff <version1> <version2>"
        echo "Example: $0 --diff v0.0.9-11-g218f967 v0.0.9-12-g78a7212"
        echo
        echo "Available versions:"
        ls -1 benches/go 2>/dev/null | sed 's/^/  /'
        exit 1
    fi
    diff_benchmarks "$2" "$3"
    exit 0
fi

echo -n "Regenerate parsers "
go generate ./...
if [ $? -eq 0 ]; then
    echo OK
else
    echo FAIL
    exit 1
fi

for suite in "${suites[@]}"; do
  echo "Benchmark $suite"

  TEST_PATH=./tests/${suite}

  if [ -d $TEST_PATH ]; then

      BENCH_PATH=benches/${VERSION}/${suite}
      mkdir -p $BENCH_PATH
      echo "Output path: $BENCH_PATH"

      go test ${TEST_PATH}/... -v -run=^$ \
         -bench=BenchmarkParser\/ -benchmem    \
         -memprofile "${BENCH_PATH}/mem.out"  \
         -cpuprofile "${BENCH_PATH}/cpu.out"  \
         -benchtime 2s -count 15 | tee $BENCH_PATH/txt

      BENCH_PATH_NOCAP=benches/${VERSION}/${suite}_nocap
      mkdir -p $BENCH_PATH_NOCAP
      echo "Output path: $BENCH_PATH_NOCAP"

      go test ${TEST_PATH}/... -v -run=^$ \
         -bench=BenchmarkNoCapParser/ -benchmem     \
         -memprofile "${BENCH_PATH_NOCAP}/mem.out"  \
         -cpuprofile "${BENCH_PATH_NOCAP}/cpu.out"  \
         -benchtime 2s -count 15 | tee $BENCH_PATH_NOCAP/txt

      if [ "${suite}" = "json" ]; then
          BENCH_STRIPPED_PATH=benches/${VERSION}/${suite}_stripped
          mkdir -p $BENCH_STRIPPED_PATH
          echo "Output path: $BENCH_STRIPPED_PATH"

          go test ${TEST_PATH}/... -v -run=^$ \
             -bench=BenchmarkStrippedParser\/ -benchmem    \
             -memprofile "${BENCH_STRIPPED_PATH}/mem.out"  \
             -cpuprofile "${BENCH_STRIPPED_PATH}/cpu.out"  \
             -benchtime 2s -count 15 | tee $BENCH_STRIPPED_PATH/txt

          BENCH_STRIPPED_PATH_NOCAP=benches/${VERSION}/${suite}_stripped_nocap
          mkdir -p $BENCH_STRIPPED_PATH_NOCAP
          echo "Output path: $BENCH_STRIPPED_PATH_NOCAP"

          go test ${TEST_PATH}/... -v -run=^$ \
             -bench=BenchmarkStrippedNoCapParser/ -benchmem     \
             -memprofile "${BENCH_STRIPPED_PATH_NOCAP}/mem.out"  \
             -cpuprofile "${BENCH_STRIPPED_PATH_NOCAP}/cpu.out"  \
             -benchtime 2s -count 15 | tee $BENCH_STRIPPED_PATH_NOCAP/txt
      fi

  else
      echo "Don't have the suite ${suite} :("
  fi
done
